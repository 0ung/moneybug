<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tagreply">

	<insert id="insert" parameterType="tagreplyDTO"
		useGeneratedKeys="true" keyProperty="seq">
		<selectKey keyProperty="groupSeq" resultType="int"
			order="BEFORE">
			SELECT IFNULL(MAX(GROUP_SEQ), 0) + 1 FROM tag_reply
		</selectKey>
		insert into tag_reply (SEQ,
		BOARD_SEQ, CONTENT, WRITER_ID, CREATE_AT,
		ORIGIN_SEQ, REPLY_ORDER,
		REPLY_LEVEL, GROUP_SEQ)
		values (null,
		#{boardSeq}, #{content}, #{writerId}, now(),
		null, 0, 0, #{groupSeq})
	</insert>

	<insert id="reinsert" parameterType="tagreplyDTO"
		useGeneratedKeys="true" keyProperty="SEQ">
		<selectKey keyProperty="groupSeq" resultType="int"
			order="BEFORE">
			SELECT GROUP_SEQ FROM tag_reply WHERE SEQ = #{originSeq}
		</selectKey>
		insert into tag_reply (SEQ,
		BOARD_SEQ, CONTENT, WRITER_ID, CREATE_AT, ORIGIN_SEQ, REPLY_ORDER,
		REPLY_LEVEL, GROUP_SEQ)
		SELECT
		null, #{boardSeq}, #{content}, #{writerId}, now(),
		#{originSeq},
		COALESCE(MAX(REPLY_ORDER), 0) + 1, 1, #{groupSeq}
		FROM tag_reply WHERE
		ORIGIN_SEQ = #{originSeq}
	</insert>



	<select id="list" resultType="tagreplyDTO" parameterType="tagreplypageDTO">
    select * from 
    (select ROW_NUMBER() 
    over(order by GROUP_SEQ asc,
    CASE WHEN SEQ = ORIGIN_SEQ THEN REPLY_ORDER ELSE SEQ END asc,
    REPLY_ORDER asc,
    SEQ asc) as rowNo, 
    SEQ, WRITER_ID, CONTENT, CREATE_AT, BOARD_SEQ, ORIGIN_SEQ, REPLY_LEVEL, REPLY_ORDER, GROUP_SEQ from tag_reply
    ) tr
    where tr.rowNo BETWEEN #{start} and #{end}
    and tr.BOARD_SEQ = #{seq}
</select>





	<update id="update" parameterType="tagreplyDTO">
		update tag_reply set CONTENT =
		#{content} WHERE SEQ = #{seq}
	</update>

	<delete id="delete">
		delete from tag_reply WHERE SEQ = #{seq}
	</delete>

	<select id="count" resultType="Integer">
		select count(*) from tag_reply
		where BOARD_SEQ= #{boardSeq}
	</select>

</mapper>











